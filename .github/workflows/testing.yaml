name: ğŸ§ª CI Pipeline 1 -- Testing

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
    push:
        branches:
            - "**"
        tags:
            - "*.*.*"
        paths:
            - "**"
            - "!docs/**"
            - "!examples/**"
    pull_request:
        paths:
            - "**"
            - "!docs/**"
            - "!examples/**"

env:
    TERM: xterm
    VENV_PATH: .venv
    PYTHON_VERSION: "3.11"
    FORCE_COLOR: "1"  # Force color output in CI

jobs:
    # Verifies pep8, pyflakes, circular complexity, and spelling
    lint:
        name: ğŸš¨ Lint and spellcheck
        runs-on: ubuntu-latest
        steps:
            # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
            - name: â¬‡ï¸ Checkout code
              uses: actions/checkout@v4
            - name: ğŸ Set up Python v${{ env.PYTHON_VERSION }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
            - name: ğŸ”½ Install flake8
              run: pip install flake8
            - name: âŒ› Lint Python code
              run: flake8 -v rocrate_validator tests
            - name: âŒ› Spell check code and profiles (covers Python and SHACL)
              uses: crate-ci/typos@v1.41.0

    # Runs the tests
    test:
        name: âŒ› Run tests
        runs-on: ubuntu-latest
        needs: [flake8]
        steps:
            - name: â¬‡ï¸ Checkout
              uses: actions/checkout@v4
            - name: ğŸ Set up Python v${{ env.PYTHON_VERSION }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
            - name: ğŸ”„ Upgrade pip
              run: pip install --upgrade pip
            - name: ğŸ Initialise a virtual env
              run: python -m venv ${VENV_PATH}
            - name: ğŸ Enable virtual env
              run: source ${VENV_PATH}/bin/activate
            - name: ğŸ”½ Install Poetry
              run: pip install poetry
            - name: ğŸ”½ Install dependencies
              run: poetry install --no-interaction --no-ansi
            - name: âŒ› Run tests
              run: poetry run pytest
              env:
                TERM: "dumb"
                LINES: "50"
                COLUMNS: "120"
