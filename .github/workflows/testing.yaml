# Copyright (c) 2024-2026 CRS4
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: üß™ CI Pipeline 1 -- Testing

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
    push:
        branches:
            - "**"
        tags:
            - "*.*.*"
        paths:
            - "**"
            - "!docs/**"
            - "!examples/**"
    pull_request:
        paths:
            - "**"
            - "!docs/**"
            - "!examples/**"

env:
    TERM: xterm
    VENV_PATH: .venv
    PYTHON_VERSION: "3.11"
    FORCE_COLOR: "1"  # Force color output in CI

jobs:
    # Verifies pep8, pyflakes, circular complexity, and spelling
    lint:
        name: üö® Lint and spellcheck
        runs-on: ubuntu-latest
        steps:
            # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
            - name: ‚¨áÔ∏è Checkout code
              uses: actions/checkout@v4
            - name: üêç Set up Python v${{ env.PYTHON_VERSION }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
            - name: üîΩ Install flake8
              run: pip install flake8
            - name: ‚åõ Lint Python code
              run: flake8 -v rocrate_validator tests
            - name: ‚åõ Spell check code and profiles (covers Python and SHACL)
              uses: crate-ci/typos@v1.41.0

    # Runs the tests
    test:
        name: ‚åõ Run tests
        runs-on: ubuntu-latest
        needs: [lint]
        steps:
            - name: ‚¨áÔ∏è Checkout
              uses: actions/checkout@v4
            - name: üêç Set up Python v${{ env.PYTHON_VERSION }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
            - name: üîÑ Upgrade pip
              run: pip install --upgrade pip
            - name: üêç Initialise a virtual env
              run: python -m venv ${VENV_PATH}
            - name: üêç Enable virtual env
              run: source ${VENV_PATH}/bin/activate
            - name: üîΩ Install Poetry
              run: pip install poetry
            - name: üîΩ Install dependencies
              run: poetry install --no-interaction --no-ansi
            - name: ‚åõ Run tests
              run: poetry run pytest
              env:
                TERM: "dumb"
                LINES: "50"
                COLUMNS: "120"
